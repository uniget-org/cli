name: Release

on:
  push:
    tags:
    - "v*"

jobs:

  prepare:
    name: Prepare
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.get_version.outputs.tag }}
      version: ${{ steps.get_version.outputs.version }}
    steps:

    - name: printenv
      run: |
        printenv | sort

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ needs.prepare.outputs.tag }}

    - name: Get version
      id: get_version
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        echo "tag=${TAG}" >>"${GITHUB_OUTPUT}"
        echo "version=${TAG#v}" >>"${GITHUB_OUTPUT}"

  release:
    name: Release
    needs:
    - prepare
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ needs.prepare.outputs.tag }}

    - name: Bootstrap uniget
      run: |
        make snapshot
        mv uniget /tmp/
        /tmp/uniget --prefix=helper update
        /tmp/uniget --prefix=helper install go goreleaser syft
        rm /tmp/uniget

    - name: Check for dirty working directory
      run: |
        git status

    - name: Build and release binaries
      env:
        GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      run: |
        helper/usr/local/bin/goreleaser release --skip-sbom
