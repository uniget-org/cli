default:
  tags:
  - saas-linux-medium-amd64

include:
- local: pipeline/docker.yaml

lint:
  rules:
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  - if: $CI_COMMIT_TAG =~ /^v/
  - if: $CI_MERGE_REQUEST_ID
  extends:
  - .docker
  - .docker:dind
  script: |
    docker buildx bake lint

test:
  rules:
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  - if: $CI_COMMIT_TAG =~ /^v/
  - if: $CI_MERGE_REQUEST_ID
  extends:
  - .docker
  - .docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script: |
    docker buildx bake test

cli_test:
  rules:
  - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  - if: $CI_COMMIT_TAG =~ /^v/
  - if: $CI_MERGE_REQUEST_ID
  extends:
  - .docker
  - .docker:dind
  script: |
    docker buildx bake cli-test